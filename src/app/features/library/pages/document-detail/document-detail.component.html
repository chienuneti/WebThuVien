<div class="book-detail-container" *ngIf="document">
  <button class="btn-back" (click)='goBack()' style="margin-bottom: 10px;">
    ‚Üê Quay l·∫°i
  </button>
  <div class="book-header">
    <div class="book-main">
      <div class="book-cover-section">
        <div class="book-cover-large">
          <img [src]="document.coverPath ? document.coverPath : '/assets/images/default-cover.png'"
            (error)="onImgError($event)" [alt]="document.title" />
        </div>
        <div class="book-actions">
          <a [routerLink]="['/library/read', document.id]" class="btn-primary">
            ƒê·ªçc tr·ª±c tuy·∫øn
          </a>

          <button class="btn-secondary" *ngIf="files.length > 0" (click)="download(files[0])">
            T·∫£i xu·ªëng (V{{files[0].version}})
          </button>
        </div>
      </div>

      <div class="book-info-section">


        <h1 class="book-title">{{ document.title }}</h1>

        <p class="book-author">T√°c gi·∫£:
          <span *ngFor="let author of document.authors; let last = last">
            <strong>{{ author.name }}</strong>{{ !last ? ', ' : '' }}
          </span>
        </p>

        <div class="identifiers-list" *ngIf="document.identifiers && document.identifiers.length > 0">
          <div class="identifier-item" *ngFor="let iden of document.identifiers">
            <span class="iden-label">{{ iden.type }}:</span>
            <span class="iden-value">{{ iden.value }}</span>
          </div>
        </div>

        <div class="book-meta">
          <div class="meta-item">
            <div class="meta-label">Lo·∫°i t√†i li·ªáu</div>
            <div class="meta-value">{{ document.documentType }}</div>
          </div>
          <div class="meta-item">
            <div class="meta-label">S·ªë trang</div>
            <div class="meta-value">{{ document.pageNum }}</div>
          </div>
          <div class="meta-item">
            <div class="meta-label">NƒÉm xu·∫•t b·∫£n</div>
            <div class="meta-value">{{ document.publicationDate | date: 'yyyy' }}</div>
          </div>
        </div>

        <div class="type-specific-info"
          *ngIf="document.internalBook || document.thesis || document.research || document.externalBook || document.researchPublication">

          <div *ngIf="document.thesis">
            <div class="sub-info-grid">
              <div class="sub-info-item">
                <span class="sub-label">C·∫•p b·∫≠c:</span>
                <span class="sub-value">{{ document.thesis.degreeLevel || '---' }}</span>
              </div>
              <div class="sub-info-item">
                <span class="sub-label">Chuy√™n ng√†nh:</span>
                <span class="sub-value">{{ document.thesis.discipline || '---' }}</span>
              </div>
              <div class="sub-info-item">
                <span class="sub-label">GV H∆∞·ªõng d·∫´n:</span>
                <span class="sub-value">{{ document.thesis.advisorName || '---' }}</span>
              </div>
            </div>

            <div class="abstract-block" *ngIf="document.thesis.abstract">
              <span class="sub-label">T√≥m t·∫Øt lu·∫≠n vƒÉn:</span>
              <p class="abstract-content">{{ document.thesis.abstract }}</p>
            </div>
          </div>



          <div class="sub-info-grid" *ngIf="document.internalBook">
            <div class="sub-info-item">
              <span class="sub-label">Khoa:</span>
              <span class="sub-value">{{ document.internalBook.faculty }}</span>
            </div>
            <div class="sub-info-item">
              <span class="sub-label">Lo·∫°i b√†i gi·∫£ng:</span>
              <span class="sub-value">{{ document.internalBook.documentType }}</span>
            </div>
            <div class="sub-info-item">
              <span class="sub-label">Phi√™n b·∫£n:</span>
              <span class="sub-value">V.{{ document.internalBook.version }}</span>
            </div>
          </div>

          <div class="sub-info-grid" *ngIf="document.research">
            <div class="sub-info-item">
              <span class="sub-label">C·∫•p qu·∫£n l√Ω:</span>
              <span class="sub-value">{{ document.research.researchLevel }}</span>
            </div>
            <div class="sub-info-item">
              <span class="sub-label">T√≥m t·∫Øt ƒë·ªÅ t√†i:</span>
              <span class="sub-value">{{ document.research.abstract }}</span>
            </div>
          </div>

          <div class="sub-info-grid" *ngIf="document.externalBook">
            <div class="sub-info-item">
              <span class="sub-label">Nh√† xu·∫•t b·∫£n:</span>
              <span class="sub-value">{{ document.externalBook.publisher }}</span>
            </div>
            <div class="sub-info-item">
              <span class="sub-label">Phi√™n b·∫£n:</span>
              <span class="sub-value">{{ document.externalBook.version }}</span>
            </div>
          </div>

          <div class="sub-info-grid" *ngIf="document.researchPublication">
            <div class="sub-info-item">
              <span class="sub-label">N∆°i c√¥ng b·ªë:</span>
              <span class="sub-value">{{ document.researchPublication.venueName }}</span>
            </div>
            <div class="sub-info-item">
              <span class="sub-label">Lo·∫°i c√¥ng b·ªë:</span>
              <span class="sub-value">{{ document.researchPublication.publicationType }}</span>
            </div>
          </div>
        </div>

        <div class="book-description">
          <div class="book-description">
            <h3>M√¥ t·∫£ t√†i li·ªáu</h3>
            <p>{{ document.description || 'Ch∆∞a c√≥ m√¥ t·∫£ cho t√†i li·ªáu n√†y.' }}</p>
          </div>
          <div class="book-tags" *ngIf="document.keywords">
            <span class="tag" *ngFor="let kw of document.keywords">#{{ kw }}</span>
          </div>
        </div>
      </div>
    </div>

    <div class="reviews-section">
      <h2 class="section-title">Reviews({{ reviews.length }})</h2>

      <div class="add-review-container" *ngIf="isLoggedIn; else loginPrompt">
        <h3>Vi·∫øt nh·∫≠n x√©t c·ªßa b·∫°n</h3>
        <div class="rating-input">
          <span *ngFor="let i of [1,2,3,4,5]" (click)="userRating = i" [class.active]="i <= userRating"
            class="star-icon">‚òÖ</span>
          <span class="rating-label">{{ userRating }}/5 sao</span>
        </div>
        <textarea [(ngModel)]="userComment" placeholder="Chia s·∫ª c·∫£m nghƒ© c·ªßa b·∫°n v·ªÅ t√†i li·ªáu n√†y..."
          class="comment-textarea"></textarea>
        <div class="form-actions">
          <button (click)="submitReview()" [disabled]="!userComment.trim() || isSubmitting" class="btn-submit-review">
            {{ isSubmitting ? 'ƒêang g·ª≠i...' : 'G·ª≠i ƒë√°nh gi√°' }}
          </button>
        </div>
      </div>

      <ng-template #loginPrompt>
        <div class="login-msg">
          <p>Vui l√≤ng <a routerLink="/dang-nhap">ƒëƒÉng nh·∫≠p</a> ƒë·ªÉ g·ª≠i ƒë√°nh gi√° v√† b√¨nh lu·∫≠n cho t√†i li·ªáu n√†y.</p>
        </div>
      </ng-template>

      <div class="reviews-list">
        <div *ngFor="let r of reviews" class="review-item-card">
          <div class="review-header">
            <div class="user-avatar">{{ r.userName.charAt(0).toUpperCase() }}</div>
            <div class="user-info">
              <div class="user-name">{{ r.userName }}</div>
              <div class="user-rating-stars">
                <span *ngFor="let s of [1,2,3,4,5]" [class.filled]="s <= (r.rating || 0)">‚òÖ</span>
              </div>
            </div>
            <div class="review-date">{{ r.createdAt | date:'dd/MM/yyyy' }}</div>
          </div>
          <div class="review-content">
            {{ r.content }}
          </div>
        </div>

        <div *ngIf="reviews.length === 0" class="no-reviews">
          <div class="empty-icon">üí¨</div>
          <p>Ch∆∞a c√≥ b√¨nh lu·∫≠n n√†o. H√£y l√† ng∆∞·ªùi ƒë·∫ßu ti√™n chia s·∫ª c·∫£m nghƒ©!</p>
        </div>
      </div>
    </div>
  </div>

  <div *ngIf="loading" class="loading-overlay">
    <div class="spinner"></div>
    <p>ƒêang t·∫£i d·ªØ li·ªáu...</p>
  </div>

  <div *ngIf="error" class="error-container">
    <p>{{ error }}</p>
    <button routerLink="/library">Quay l·∫°i danh s√°ch</button>
  </div>