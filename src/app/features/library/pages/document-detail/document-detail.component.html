<div class="book-detail-container" *ngIf="document">
  <div class="book-header">
    <div class="book-main">
      <!-- C·ªôt tr√°i: ·∫¢nh b√¨a & H√†nh ƒë·ªông -->
      <div class="book-cover-section">
        <div class="book-cover-large">
          <!-- S·ª≠ d·ª•ng ·∫£nh m·∫∑c ƒë·ªãnh n·∫øu kh√¥ng c√≥ coverPath -->
          <!-- S·ª≠a doc th√†nh document -->
<img [src]="document.coverPath ? '/' + document.coverPath : '/assets/images/default-book.png'" 
     (error)="onImgError($event)"
     [alt]="document.title" />
        </div>
        <div class="book-actions">
  <!-- N√∫t ƒê·ªçc: D·∫´n sang trang Reader -->
  <a [routerLink]="['/library/read', document.id]" class="btn-primary">
    üìñ ƒê·ªçc tr·ª±c tuy·∫øn
  </a>

  <!-- N√∫t T·∫£i xu·ªëng: G·ªçi h√†m download file phi√™n b·∫£n m·ªõi nh·∫•t -->
  <button class="btn-secondary" *ngIf="files.length > 0" (click)="download(files[0])">
    üì• T·∫£i xu·ªëng (V{{files[0].version}})
  </button>
</div>
      </div>

      <!-- C·ªôt ph·∫£i: Th√¥ng tin chi ti·∫øt -->
      <div class="book-info-section">
        <h1 class="book-title">{{ document.title }}</h1>
  
  <!-- C·∫≠p nh·∫≠t hi·ªÉn th·ªã T√°c gi·∫£ (v√¨ authors l√† m·∫£ng object) -->
  <p class="book-author">T√°c gi·∫£: 
    <span *ngFor="let author of document.authors; let last = last">
      <strong>{{ author.name }}</strong>{{ !last ? ', ' : '' }}
    </span>
  </p>

  <!-- PH·∫¶N M·ªöI: HI·ªÇN TH·ªä IDENTIFIERS (M√£ ƒë·ªãnh danh) -->
  <div class="identifiers-list" *ngIf="document.identifiers && document.identifiers.length > 0">
    <div class="identifier-item" *ngFor="let iden of document.identifiers">
      <span class="iden-label">{{ iden.type }}:</span>
      <span class="iden-value">{{ iden.value }}</span>
    </div>
  </div>

        <!-- ... c√°c ph·∫ßn tr√™n gi·ªØ nguy√™n ... -->
<div class="book-meta">
  <div class="meta-item">
    <div class="meta-label">Lo·∫°i t√†i li·ªáu</div>
    <div class="meta-value">{{ document.documentType }}</div>
  </div>
  <div class="meta-item">
    <div class="meta-label">S·ªë trang</div>
    <div class="meta-value">{{ document.pageNum }}</div>
  </div>
  <div class="meta-item">
    <div class="meta-label">NƒÉm xu·∫•t b·∫£n</div>
    <div class="meta-value">{{ document.publicationDate | date: 'yyyy' }}</div>
  </div>
</div>

<!-- TH√îNG TIN CHI TI·∫æT THEO LO·∫†I (Internal, Thesis, Research, ...) -->
<div class="type-specific-info" *ngIf="document.internalBook || document.thesis || document.research || document.externalBook || document.researchPublication">
  
  <!-- Hi·ªÉn th·ªã cho Thesis (Lu·∫≠n vƒÉn) -->
<div *ngIf="document.thesis">
  <!-- C√°c th√¥ng tin ng·∫Øn th√¨ ƒë·ªÉ trong Grid -->
  <div class="sub-info-grid">
    <div class="sub-info-item">
      <span class="sub-label">C·∫•p b·∫≠c:</span>
      <span class="sub-value">{{ document.thesis.degreeLevel || '---' }}</span>
    </div>
    <div class="sub-info-item">
      <span class="sub-label">Chuy√™n ng√†nh:</span>
      <span class="sub-value">{{ document.thesis.discipline || '---' }}</span>
    </div>
    <div class="sub-info-item">
      <span class="sub-label">GV H∆∞·ªõng d·∫´n:</span>
      <span class="sub-value">{{ document.thesis.advisorName || '---' }}</span>
    </div>
  </div>

  <!-- Ph·∫ßn Abstract t√°ch ri√™ng xu·ªëng d∆∞·ªõi ƒë·ªÉ r·ªông r√£i -->
  <div class="abstract-block" *ngIf="document.thesis.abstract">
    <span class="sub-label">T√≥m t·∫Øt lu·∫≠n vƒÉn:</span>
    <p class="abstract-content">{{ document.thesis.abstract }}</p>
  </div>
</div>



  <!-- 2. Hi·ªÉn th·ªã cho InternalBook (S√°ch n·ªôi b·ªô) -->
  <div class="sub-info-grid" *ngIf="document.internalBook">
    <div class="sub-info-item">
      <span class="sub-label">Khoa:</span>
      <span class="sub-value">{{ document.internalBook.faculty }}</span>
    </div>
    <div class="sub-info-item">
      <span class="sub-label">Lo·∫°i b√†i gi·∫£ng:</span>
      <span class="sub-value">{{ document.internalBook.documentType }}</span>
    </div>
    <div class="sub-info-item">
      <span class="sub-label">Phi√™n b·∫£n:</span>
      <span class="sub-value">V.{{ document.internalBook.version }}</span>
    </div>
  </div>

  <div class="sub-info-grid" *ngIf="document.research">
    <div class="sub-info-item">
      <span class="sub-label">C·∫•p qu·∫£n l√Ω:</span>
      <span class="sub-value">{{ document.research.researchLevel }}</span>
    </div>
    <div class="sub-info-item">
      <span class="sub-label">T√≥m t·∫Øt ƒë·ªÅ t√†i:</span>
      <span class="sub-value">{{ document.research.abstract }}</span>
    </div>
  </div>

  <div class="sub-info-grid" *ngIf="document.externalBook">
    <div class="sub-info-item">
      <span class="sub-label">Nh√† xu·∫•t b·∫£n:</span>
      <span class="sub-value">{{ document.externalBook.publisher }}</span>
    </div>
    <div class="sub-info-item">
      <span class="sub-label">Phi√™n b·∫£n:</span>
      <span class="sub-value">{{ document.externalBook.version }}</span>
    </div>
  </div>

  <div class="sub-info-grid" *ngIf="document.researchPublication">
    <div class="sub-info-item">
      <span class="sub-label">N∆°i c√¥ng b·ªë:</span>
      <span class="sub-value">{{ document.researchPublication.venueName }}</span>
    </div>
    <div class="sub-info-item">
      <span class="sub-label">Lo·∫°i c√¥ng b·ªë:</span>
      <span class="sub-value">{{ document.researchPublication.publicationType }}</span>
    </div>
  </div>
</div>

<div class="book-description">
<!-- ... c√°c ph·∫ßn sau gi·ªØ nguy√™n ... -->

        <div class="book-description">
          <h3>M√¥ t·∫£ t√†i li·ªáu</h3>
          <p>{{ document.description || 'Ch∆∞a c√≥ m√¥ t·∫£ cho t√†i li·ªáu n√†y.' }}</p>
        </div>
        <div class="book-tags" *ngIf="document.keywords">
          <span class="tag" *ngFor="let kw of document.keywords">#{{ kw }}</span>
        </div>
      </div>
    </div>
  </div>

  <!-- PH·∫¶N ƒê√ÅNH GI√Å & B√åNH LU·∫¨N (Thay th·∫ø cho danh s√°ch t·ªáp tin) -->
<div class="reviews-section">
  <h2 class="section-title">Reviews({{ reviews.length }})</h2>

  <!-- 1. Form g·ª≠i b√¨nh lu·∫≠n m·ªõi -->
  <div class="add-review-container" *ngIf="isLoggedIn; else loginPrompt">
    <h3>Vi·∫øt nh·∫≠n x√©t c·ªßa b·∫°n</h3>
    <div class="rating-input">
      <span *ngFor="let i of [1,2,3,4,5]" 
            (click)="userRating = i" 
            [class.active]="i <= userRating"
            class="star-icon">‚òÖ</span>
      <span class="rating-label">{{ userRating }}/5 sao</span>
    </div>
    <textarea 
      [(ngModel)]="userComment" 
      placeholder="Chia s·∫ª c·∫£m nghƒ© c·ªßa b·∫°n v·ªÅ t√†i li·ªáu n√†y..."
      class="comment-textarea"></textarea>
    <div class="form-actions">
      <button 
        (click)="submitReview()" 
        [disabled]="!userComment.trim() || isSubmitting" 
        class="btn-submit-review">
        {{ isSubmitting ? 'ƒêang g·ª≠i...' : 'G·ª≠i ƒë√°nh gi√°' }}
      </button>
    </div>
  </div>

  <!-- Th√¥ng b√°o n·∫øu ch∆∞a ƒëƒÉng nh·∫≠p -->
  <ng-template #loginPrompt>
    <div class="login-msg">
      <p>Vui l√≤ng <a routerLink="/dang-nhap">ƒëƒÉng nh·∫≠p</a> ƒë·ªÉ g·ª≠i ƒë√°nh gi√° v√† b√¨nh lu·∫≠n cho t√†i li·ªáu n√†y.</p>
    </div>
  </ng-template>

  <!-- 2. Danh s√°ch c√°c b√¨nh lu·∫≠n hi·ªán c√≥ -->
  <div class="reviews-list">
    <div *ngFor="let r of reviews" class="review-item-card">
      <div class="review-header">
        <!-- Avatar gi·∫£ l·∫≠p b·∫±ng ch·ªØ c√°i ƒë·∫ßu t√™n -->
        <div class="user-avatar">{{ r.userName.charAt(0).toUpperCase() }}</div>
        <div class="user-info">
          <div class="user-name">{{ r.userName }}</div>
          <div class="user-rating-stars">
            <span *ngFor="let s of [1,2,3,4,5]" 
                  [class.filled]="s <= (r.rating || 0)">‚òÖ</span>
          </div>
        </div>
        <div class="review-date">{{ r.createdAt | date:'dd/MM/yyyy' }}</div>
      </div>
      <div class="review-content">
        {{ r.content }}
      </div>
    </div>

    <!-- Tr·∫°ng th√°i tr·ªëng -->
    <div *ngIf="reviews.length === 0" class="no-reviews">
      <div class="empty-icon">üí¨</div>
      <p>Ch∆∞a c√≥ b√¨nh lu·∫≠n n√†o. H√£y l√† ng∆∞·ªùi ƒë·∫ßu ti√™n chia s·∫ª c·∫£m nghƒ©!</p>
    </div>
  </div>
</div>
</div>

<!-- Loading State -->
<div *ngIf="loading" class="loading-overlay">
  <div class="spinner"></div>
  <p>ƒêang t·∫£i d·ªØ li·ªáu...</p>
</div>

<!-- Error State -->
<div *ngIf="error" class="error-container">
  <p>{{ error }}</p>
  <button routerLink="/library">Quay l·∫°i danh s√°ch</button>
</div>